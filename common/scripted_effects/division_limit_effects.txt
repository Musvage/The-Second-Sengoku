set_up_global_division_limit_system = {
	set_variable = { global.division_limit_base = 300 }
	# economic laws
	set_variable = { global.division_limit_undisturbed_isolation = -90 }
	set_variable = { global.division_limit_isolation = -40 }
	set_variable = { global.division_limit_civilian_economy = 0 }
	set_variable = { global.division_limit_low_economic_mobilisation = 20 }
	set_variable = { global.division_limit_partial_economic_mobilisation = 60 }
	set_variable = { global.division_limit_war_economy = 90 }
	set_variable = { global.division_limit_tot_economic_mobilisation = 120 }
	# manpower laws CURRENTLY DEPRICATED
	set_variable = { global.division_limit_disarmed_nation = -60 }
	set_variable = { global.division_limit_volunteer_only = -20 }
	set_variable = { global.division_limit_limited_conscription = 0 }
	set_variable = { global.division_limit_extensive_conscription = 20 }
	set_variable = { global.division_limit_service_by_requirement = 60 }
	set_variable = { global.division_limit_all_adults_serve = 90 }
	set_variable = { global.division_limit_scraping_the_barrel = 120 }
	# training level
	set_variable = { global.division_limit_soldier_baptism = 120 }
	set_variable = { global.division_limit_soldier_basic = 60 }
	set_variable = { global.division_limit_soldier_full = 0 }
	set_variable = { global.division_limit_soldier_extended = -20 }
	# support company
	set_variable = { global.division_limit_support_companies_tech_level = 0 }
	# advisor
	set_variable = { global.division_limit_advisor_1 = 0.05 }
	set_variable = { global.division_limit_advisor_2 = 0.1 }
	set_variable = { global.division_limit_advisor_3 = 0.15 }
	# infrastructure
	set_variable = { global.division_limit_infrastructure = 0.05 }
	# other variables
	set_variable = { global.division_limit_food_surplus = 20 }
	set_global_flag = has_global_division_system
	### TECHNOLOGIES BONUS VALUES
	set_variable = { global.division_limit_doctrine_small = 15 }
	set_variable = { global.division_limit_doctrine_medium = 30 }
	set_variable = { global.division_limit_doctrine_big = 60 }

	every_country = { 
		set_variable = { desire_to_go_overhead = 0 }	# Matters only for AI
		set_up_division_limit_system = yes
	}
}

set_up_division_limit_system = {
	set_country_flag = has_division_limit_system
	if = {
		limit = { NOT = { check_variable = { division_limit_technology_bonus = 0 } } }	# does not loose technological advances from starting techs or when resetting system for debug
		set_variable = { division_limit_technology_bonus = 0 }
	}
	if = {
		limit = { NOT = { check_variable = { division_limit_other_bonus = 0 } } }	# does not loose other bonuses from starting bonuses or when resetting system for debug
		set_variable = { division_limit_other_bonus = 0 }
	} else = {
		if = {
			limit = {
				OR = { has_tech = superior_firepower has_tech = mobile_warfare }
			}
			division_limit_add_small_doctrine_bonus = yes
		}
		if = {
			limit = {
				has_tech = trench_warfare
			}
			division_limit_add_medium_doctrine_bonus = yes
		}
		if = {
			limit = {
				has_tech = mass_assault
			}
			division_limit_add_big_doctrine_bonus = yes
		}
	}
	if = {
		limit = { NOT = { check_variable = { division_limit_other_multiplier = 0 } } }	# does not loose other multipliers from starting bonuses or when resetting system for debug
		set_variable = { division_limit_other_multiplier = 0 }
	}
	if = {
		limit = { NOT = { check_variable = { division_limit_support_companies_tech_level = 0 } } }	# does not loose support tech when starting the game or resetting system for debug
		set_variable = { division_limit_support_companies_tech_level = 0 }
	}
	calculate_division_limit = yes
}

calculate_average_infrastructure_level = {
	
	set_temp_variable = { total_infrastructure_weight = 0 }

	every_controlled_state = {
		add_to_temp_variable = { PREV.total_infrastructure_weight = division_limit_infrastructure_weight }
	}
	
	set_variable = { average_infrastructure_level = 0 }
	
	every_controlled_state = {
		set_temp_variable = { state_infrastructure_level = non_damaged_building_level@infrastructure }
		multiply_temp_variable = { state_infrastructure_level = division_limit_infrastructure_weight }
		add_to_variable = { PREV.average_infrastructure_level = state_infrastructure_level }
	}
	divide_variable = { average_infrastructure_level = total_infrastructure_weight }
	set_variable = { debug_weights_total = total_infrastructure_weight }	## DEBUG ## DEBUG ## DEBUG ## DEBUG 
}

calculate_support_companies = {

	set_variable = { num_battalions_support = num_battalions_with_type@engineer }
	add_to_variable = { num_battalions_support = num_battalions_with_type@recon }
	add_to_variable = { num_battalions_support = num_battalions_with_type@mot_recon }
	add_to_variable = { num_battalions_support = num_battalions_with_type@armored_car_recon }
	add_to_variable = { num_battalions_support = num_battalions_with_type@light_tank_recon }
	add_to_variable = { num_battalions_support = num_battalions_with_type@military_police }
	add_to_variable = { num_battalions_support = num_battalions_with_type@maintenance_company }
	add_to_variable = { num_battalions_support = num_battalions_with_type@field_hospital }
	add_to_variable = { num_battalions_support = num_battalions_with_type@logistics_company }
	add_to_variable = { num_battalions_support = num_battalions_with_type@signal_company }
	
	set_variable = { division_limit_support_companies_discount = 0 }
	set_variable = { division_limit_support_companies_bonus = 0 }
	if = {
		limit = { check_variable = { division_limit_support_companies_tech_level = 1 } }
		set_variable = { division_limit_support_companies_discount = num_battalions_support }
		divide_variable = { division_limit_support_companies_discount = 2 }								### HARDCODED VALUES
		round_variable = division_limit_support_companies_discount
	}
	if = {
		limit = { check_variable = { division_limit_support_companies_tech_level = 2 } }
		set_variable = { division_limit_support_companies_discount = num_battalions_support }
	}
	if = {
		limit = { check_variable = { division_limit_support_companies_tech_level = 3 } }
		set_variable = { division_limit_support_companies_discount = num_battalions_support }
		set_variable = { division_limit_support_companies_bonus = num_battalions_support }
		multiply_variable = { division_limit_support_companies_bonus = 0.2 }							### HARDCODED VALUES
		round_variable = division_limit_support_companies_bonus
	}
}

calculate_division_limit = {
	set_variable = { country_division_limit = global.division_limit_base }
	#### ECONOMIC LAW
	if = {
		limit = { has_idea = undisturbed_isolation }
		set_variable = { division_limit_economy_law = global.division_limit_undisturbed_isolation}
	}
	if = {
		limit = { has_idea = isolation }
		set_variable = { division_limit_economy_law = global.division_limit_isolation }
	}
	if = {
		limit = { has_idea = civilian_economy }
		set_variable = { division_limit_economy_law = global.division_limit_civilian_economy }
	}
	if = {
		limit = { has_idea = low_economic_mobilisation }
		set_variable = { division_limit_economy_law = global.division_limit_low_economic_mobilisation }
	}
	if = {
		limit = { has_idea = partial_economic_mobilisation }
		set_variable = { division_limit_economy_law = global.division_limit_partial_economic_mobilisation }
	}
	if = {
		limit = { has_idea = war_economy }
		set_variable = { division_limit_economy_law = global.division_limit_war_economy }
	}
	if = {
		limit = { has_idea = tot_economic_mobilisation }
		set_variable = { division_limit_economy_law = global.division_limit_tot_economic_mobilisation }
	}
	#### TRAINING LAW
	if = {
		limit = { has_idea = soldier_baptism }
		set_variable = { division_limit_training_law = global.division_limit_soldier_baptism }
	}
	if = {
		limit = { has_idea = soldier_basic }
		set_variable = { division_limit_training_law = global.division_limit_soldier_basic }
	}
	if = {
		limit = { has_idea = soldier_full }
		set_variable = { division_limit_training_law = global.division_limit_soldier_full }
	}
	if = {
		limit = { has_idea = soldier_extended }
		set_variable = { division_limit_training_law = global.division_limit_soldier_extended }
	}
	#### SUPPORT COMPANIES
	calculate_support_companies = yes
		
	#### ADVISOR
	set_variable = { division_limit_advisor = 0 }
	if = {
		limit = { has_idea_with_trait  = army_division_limit_1 }
		set_variable = { division_limit_advisor = global.division_limit_advisor_1 }
	}
	if = {
		limit = { has_idea_with_trait  = army_division_limit_2 }
		set_variable = { division_limit_advisor = global.division_limit_advisor_2 }
	}
	if = {
		limit = { has_idea_with_trait  = army_division_limit_3 }
		set_variable = { division_limit_advisor = global.division_limit_advisor_3 }
	}

	#### INFRASTRUCTURE
	calculate_average_infrastructure_level = yes
	set_variable = { division_limit_infrastructure = average_infrastructure_level }
	multiply_variable = { division_limit_infrastructure = global.division_limit_infrastructure }
	
	#### FOOD	DEPRICATED
	set_variable = { division_limit_food = 0 }
	every_controlled_state = {
		limit = { has_state_flag = state_has_food_surplus }
		add_to_variable = { division_limit_food = global.division_limit_food_surplus }
	}
	#### IDEAS
	# nothing yet, will be added ad-hoc
	
	### Add multipliers
	set_variable = { country_division_limit_multiplier = 1 }
	add_to_variable = { country_division_limit_multiplier = division_limit_advisor }
	add_to_variable = { country_division_limit_multiplier = division_limit_infrastructure }
	add_to_variable = { country_division_limit_multiplier = division_limit_other_multiplier }
	
	#### CALCULATE EFFECT
	add_to_variable = { country_division_limit = division_limit_economy_law }
	add_to_variable = { country_division_limit = division_limit_training_law }
	add_to_variable = { country_division_limit = division_limit_technology_bonus }
	add_to_variable = { country_division_limit = division_limit_food }
	add_to_variable = { country_division_limit = division_limit_support_companies_bonus }
	add_to_variable = { country_division_limit = division_limit_other_bonus }
	multiply_variable = { country_division_limit = country_division_limit_multiplier }
	
	### AI ONLY
	if = {
		limit = { OR = { is_ai = yes is_debug = yes } }
		division_limit_get_ai_limit = yes
	}
	round_variable = country_division_limit
	check_division_limit = yes
}

check_division_limit = {
	set_variable = { division_limit_num_battalions = num_battalions }
	subtract_from_variable = { division_limit_num_battalions = division_limit_support_companies_discount }
	if = {
		limit = {
			check_variable = { division_limit_num_battalions > country_division_limit }
		}
		set_variable = { division_limit_overhead = division_limit_num_battalions }
		divide_variable = { division_limit_overhead = country_division_limit }
		subtract_from_variable = { division_limit_overhead = 1 }
		
		if = {
			limit = {												# HARD CAP ON DEPLOYMENT
				OR = {
					check_variable = { division_limit_overhead > 0.25 }
					AND = {
						is_ai = yes
						check_variable = { division_limit_overhead > desire_to_go_overhead }
						check_variable = { desire_to_go_overhead > 0 }
					}
				}
			}
			set_variable = { minimum_training_level_mod = 9.99 }
		} else = {
			set_variable = { minimum_training_level_mod = 0 }
		}
		
		
		if = {
			limit = { check_variable = { division_limit_overhead > 0.5 } }			# EXTREME OVERHEAD PENALTY (ORG/MORALE)
			set_variable = { army_org_factor_mod = division_limit_overhead }
			add_to_variable = { army_org_factor_mod = -0.5 }
			multiply_variable = { army_org_factor_mod = -2 }
			clamp_variable = { var = army_org_factor_mod	min = -0.99	max = 0 }
		} else = {
			set_variable = { army_org_factor_mod = 0 }
		}
		
		set_variable = { command_power_gain_mult_mod = division_limit_overhead }	# COMMAND POWER
		multiply_variable = { command_power_gain_mult_mod = -2 }
		clamp_variable = { var = command_power_gain_mult_mod	min = -0.5	max = 0 }
		
		set_variable = { supply_consumption_factor_mod = division_limit_overhead }	# SUPPLY CONSUMPTION
		multiply_variable = { supply_consumption_factor_mod = 2 }
		clamp_variable = { var = supply_consumption_factor_mod	min = 0	max = 0.5 }
		
		set_variable = { mobilization_speed_mod = division_limit_overhead }			# MOBILIZATION SPEED
		multiply_variable = { mobilization_speed_mod = -2 }
		clamp_variable = { var = mobilization_speed_mod	min = -0.5	max = 0 }
		
		set_variable = { training_time_factor_mod = division_limit_overhead }		# TRAINING TIME
		multiply_variable = { training_time_factor_mod = 4 }
		clamp_variable = { var = training_time_factor_mod	min = 0	max = 1 }
		if = {
			limit = {
				NOT = {
					has_dynamic_modifier = {
						modifier = division_limit_spirit
					}
				}
			}
			add_dynamic_modifier = { modifier = division_limit_spirit } 
		}
		force_update_dynamic_modifier = yes
	} else = {
		if = {
			limit = {
				has_dynamic_modifier = {
					modifier = division_limit_spirit
				}
			}
			remove_dynamic_modifier = { modifier = division_limit_spirit }
			set_variable = { division_limit_overhead = 0 }
		}
	}
}

division_limit_add_small_doctrine_bonus = {
	
	custom_effect_tooltip = division_limit_add_small_doctrine_bonus_tt
	hidden_effect = {
		add_to_variable = { division_limit_technology_bonus = global.division_limit_doctrine_small }
		force_update_dynamic_modifier = yes
	}
}

division_limit_add_medium_doctrine_bonus = {
	
	custom_effect_tooltip = division_limit_add_medium_doctrine_bonus_tt
	hidden_effect = {
		add_to_variable = { division_limit_technology_bonus = global.division_limit_doctrine_medium }
		force_update_dynamic_modifier = yes
	}
}

division_limit_add_big_doctrine_bonus = {
	
	custom_effect_tooltip = division_limit_add_big_doctrine_bonus_tt
	hidden_effect = {
		add_to_variable = { division_limit_technology_bonus = global.division_limit_doctrine_big }
		force_update_dynamic_modifier = yes
	}
}

division_limit_get_ai_limit = {	# DOES NOT AFFECT HUMAN PLAYERS
	set_variable = { desire_to_go_overhead = 0 }
	if = {
		limit = {
			OR = {
				has_war = yes
				any_other_country = { has_wargoal_against = ROOT }
				threat > 0.5
			}
		}
		#	chuckles_i'm_in_danger = yes
		if = {
			limit = { alliance_strength_ratio < 1 }
			add_to_variable = { desire_to_go_overhead = 0.05 }
		}
		if = {
			limit = {
				any_enemy_country = {
					strength_ratio = {
						tag = ROOT
						ratio > 1
					}
				}
			}
			add_to_variable = { desire_to_go_overhead = 0.05 }
		}
		if = {
			limit = {
				OR = { has_idea = tot_economic_mobilisation  has_idea = war_economy  }
			}
			add_to_variable = { desire_to_go_overhead = 0.05 }
		}
		if = {
			limit = {
				any_enemy_country = {
					is_major = yes
				}
			}
			add_to_variable = { desire_to_go_overhead = 0.05 }
		}
		if = {
			limit = { arms_factory > 50 }
			add_to_variable = { desire_to_go_overhead = 0.05 }
		}
		if = {
			limit = { is_major = no }
			add_to_variable = { desire_to_go_overhead = 0.1 }
		}
		if = {
			limit = { has_tech = mass_assault }	### ROLE PLAYING: ORCS ORCS ORCS
			add_to_variable = { desire_to_go_overhead = -0.05 }
		}
		
		if = {
			limit = { has_tech = superior_firepower }	### ROLE PLAYING: MACHINE GUN GOES BRRRRRRR
			add_to_variable = { desire_to_go_overhead = -0.05 }
		}
		if = {
			limit = { arms_factory < 25 }
			add_to_variable = { desire_to_go_overhead = -0.05 }
		}
		if = {
			limit = { check_variable = { crash_1929_efficiency_loss < 0.25 } }
			add_to_variable = { desire_to_go_overhead = -0.05 }
		}
		if = {
			limit = { check_variable = { crash_1929_efficiency_loss < 0.12 } }
			add_to_variable = { desire_to_go_overhead = -0.05 }
		}
	}
	#clamp_variable = { var = desire_to_go_overhead min = 0 max = 0.25 }
}