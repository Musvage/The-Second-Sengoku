set_up_global_division_limit_system = {
	set_variable = { global.division_limit_base = 14 }
	# manpower laws
	set_variable = { global.division_limit_disarmed_nation = -4 }
	set_variable = { global.division_limit_volunteer_only = -2 }
	set_variable = { global.division_limit_limited_conscription = 0 }
	set_variable = { global.division_limit_extensive_conscription = 2 }
	set_variable = { global.division_limit_service_by_requirement = 4 }
	set_variable = { global.division_limit_all_adults_serve = 6 }
	set_variable = { global.division_limit_scraping_the_barrel = 8 }
	# training level
	set_variable = { global.division_limit_soldier_baptism = 8 }
	set_variable = { global.division_limit_soldier_basic = 4 }
	set_variable = { global.division_limit_soldier_full = 0 }
	set_variable = { global.division_limit_soldier_extended = -4 }
	# advisor
	set_variable = { global.division_limit_advisor_1 = 1.1 }
	set_variable = { global.division_limit_advisor_2 = 1.15 }
	set_variable = { global.division_limit_advisor_3 = 1.2 }
	#other variables
	set_variable = { global.division_limit_food_surplus = 2 }
	set_global_flag = has_global_division_system
	
	every_country = { 
		set_up_division_limit_system = yes
	}
}

set_up_division_limit_system = {
	set_country_flag = has_division_limit_system
	if = {
		limit = { NOT = { has_variable = division_limit_technology_bonus } }	# does not loose technological advances when resetting system for debug
		set_variable = { division_limit_technology_bonus = 0 }
	}
	calculate_division_limit = yes
}

calculate_division_limit = {
	set_variable = { country_division_limit = global.division_limit_base }
	#### MANPOWER LAW
	if = {
		limit = { has_idea = disarmed_nation }
		set_variable = { division_limit_manpower_law = global.division_limit_disarmed_nation }
	}
	if = {
		limit = { has_idea = volunteer_only }
		set_variable = { division_limit_manpower_law = global.division_limit_dvolunteer_only }
	}
	if = {
		limit = { has_idea = limited_conscription }
		set_variable = { division_limit_manpower_law = global.division_limit_dlimited_conscription }
	}
	if = {
		limit = { has_idea = extensive_conscription }
		set_variable = { division_limit_manpower_law = global.division_limit_dextensive_conscription }
	}
	if = {
		limit = { has_idea = service_by_requirement }
		set_variable = { division_limit_manpower_law = global.division_limit_dservice_by_requirement }
	}
	if = {
		limit = { has_idea = all_adults_serve }
		set_variable = { division_limit_manpower_law = global.division_limit_all_adults_serve }
	}
	if = {
		limit = { has_idea = scraping_the_barrel }
		set_variable = { division_limit_manpower_law = global.division_limit_scraping_the_barrel }
	}
	#### TRAINING LAW
	if = {
		limit = { has_idea = soldier_baptism }
		set_variable = { division_limit_training_law = global.division_limit_soldier_baptism }
	}
	if = {
		limit = { has_idea = soldier_basic }
		set_variable = { division_limit_training_law = global.division_limit_soldier_basic }
	}
	if = {
		limit = { has_idea = soldier_full }
		set_variable = { division_limit_training_law = global.division_limit_soldier_full }
	}
	if = {
		limit = { has_idea = soldier_extended }
		set_variable = { division_limit_training_law = global.division_limit_soldier_extended }
	}
	#### ADVISOR
	set_variable = { division_limit_advisor = 1 }
	if = {
		limit = { has_idea_with_trait  = army_division_limit_1 }
		set_variable = { division_limit_advisor = global.division_limit_advisor_1 }
	}
	if = {
		limit = { has_idea_with_trait  = army_division_limit_2 }
		set_variable = { division_limit_advisor = global.division_limit_advisor_2 }
	}
	if = {
		limit = { has_idea_with_trait  = army_division_limit_3 }
		set_variable = { division_limit_advisor = global.division_limit_advisor_3 }
	}
	#### FOOD
	set_variable = { division_limit_food = 0 }
	every_controlled_state = {
		limit = { has_state_flag = state_has_food_surplus }
		add_to_variable = { division_limit_food = global.division_limit_food_surplus }
	}
	#### IDEAS
	# nothing yet, will be added ad-hoc
	
	#### CALCULATE EFFECT
	add_to_variable = { country_division_limit = division_limit_manpower_law }
	add_to_variable = { country_division_limit = division_limit_training_law }
	add_to_variable = { country_division_limit = division_limit_technology_bonus }
	add_to_variable = { country_division_limit = division_limit_food }
	multiply_variable = { country_division_limit = division_limit_advisor }
	check_division_limit = yes
}

check_division_limit = {
	if = {
		limit = {
			num_divisions > country_division_limit
		}
		set_variable = { division_limit_overhead = num_divisions }
		divide_variable { division_limit_overhead = country_division_limit }
		if = {
			limit = { check_variable = { division_limit_overhead > 0.5 } }
			set_variable = { minimum_training_level_mod = 9.99 }
		}
		set_variable = { command_power_gain_mult_mod = division_limit_overhead }
		multiply_variable = { command_power_gain_mult_mod = -1 }
		clamp_variable = { var = command_power_gain_mult_mod	min = -0.5	max = 0 }
		set_variable = { mobilization_speed_mod = division_limit_overhead }
		multiply_variable = { mobilization_speed_mod = -1 }
		clamp_variable = { var = mobilization_speed_mod	min = -0.5	max = 0 }
		set_variable = { training_time_factor_mod = division_limit_overhead }
		multiply_variable = { training_time_factor_mod = 2 }
		clamp_variable = { var = training_time_factor_mod	min = 0	max = 1 }
		if = {
			limit = {
				NOT = {
					has_dynamic_modifier = {
						modifier = division_limit_spirit
					}
				}
			}
			add_dynamic_modifier = { modifier = division_limit_spirit } 
		}
		force_update_dynamic_modifier = yes
	} else = {
		if = {
			limit = {
				has_dynamic_modifier = {
					modifier = division_limit_spirit
				}
			}
			remove_dynamic_modifier = { modifier = division_limit_spirit }
			set_variable = { division_limit_overhead = 0 }
		}
	}
}