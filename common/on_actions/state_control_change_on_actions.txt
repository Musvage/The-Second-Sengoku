on_actions = {
	on_state_control_changed = {	
		effect = {
			### AMO_call_clans_spirit: starting compliance in non-hostile clan states: +100%
			if = {
				limit = {
					ROOT = { has_idea = AMO_call_clans_spirit }
					FROM.FROM = {
						any_country_with_core = {
							is_clan = yes
							NOT = { has_war_with = ROOT }
						}
					}
				}
				FROM.FROM = { set_compliance = 100 }
				log = "[AMO.GetName] occupied [FROM.FROM.GetName] and gained 100 compliance due to AMO_call_clans_spirit"
			}
		}
		effect = {
			### AMO_call_clans2_spirit: spawn troops in recently occupied states
			if = {
				limit = {
					ROOT = { has_idea = AMO_call_clans2_spirit }
					FROM.FROM = {
						any_country_with_core = {
							is_clan = yes
							NOT = { has_war_with = ROOT }
						}
						NOT = { has_state_flag = AMO_call_clans2_spirit_already_triggered }
					}
				}
				FROM.FROM = {
					meta_effect = {
						text = {
							create_unit = {
									division = "name = \"[STATE_NAME] Levy\" division_template = \"Ashigaru Levy\" start_experience_factor = 0.33 start_equipment_factor = 1"
									owner = ROOT
							}
						}
						STATE_NAME = "[THIS.GetName]"
					}
					set_state_flag = AMO_call_clans2_spirit_already_triggered
				}
				log = "[AMO.GetName] occupied [FROM.FROM.GetName] and gained 1 division"
			}
		}
		effect = {
			### AMO_call_clans2_spirit: lost/gained state, count number of suitable states for division cap
			if = {
				limit = { ROOT = { has_idea = AMO_call_clans2_spirit } }
				ROOT = {
					set_variable = { clan_levy_cap = 0 }
					every_controlled_state = {
						if = {
							limit = {
								any_country_with_core = {
									is_clan = yes
									exists = no
									NOT = { has_war_with = ROOT }
								}
							}
							add_to_variable = { ROOT.clan_levy_cap = 1 }
						}
					}
					set_division_template_cap = { 
						division_template = "Ashigaru Levy" 
						division_cap = clan_levy_cap
					}
				}
				log = "ROOT [ROOT.GetAdjective] check number irregulars: [?ROOT.clan_levy_cap]"
			}
			if = {
				limit = { FROM = { has_idea = AMO_call_clans2_spirit } }
				FROM = {
					set_variable = { clan_levy_cap = 0 }
					every_controlled_state = {
						if = {
							limit = {
								any_country_with_core = {
									is_clan = yes
									exists = no
									NOT = { has_war_with = FROM }
								}
							}
							add_to_variable = { FROM.clan_levy_cap = 1 }
						}
					}
					set_division_template_cap = { 
						division_template = "Ashigaru Levy" 
						division_cap = clan_levy_cap
					}
				}
				log = "FROM [FROM.GetAdjective] check number irregulars: [?FROM.clan_levy_cap]"
			}
		}
		effect = {
			### TRADE CITIES 2.0 ###
			if = {# when states change controller, both check for trade cities
				limit = {
					OR = {
						FROM.FROM = { state = 16 }
						FROM.FROM = { state = 27 }
						FROM.FROM = { state = 99 }
						FROM.FROM = { state = 21 }
						FROM.FROM = { state = 143 }
						FROM.FROM = { state = 141 }
						FROM.FROM = { state = 140 }
						FROM.FROM = { state = 215 }
						FROM.FROM = { state = 228 }
						FROM.FROM = { state = 1 }	# TO-DO: change later!
					}
				}
				ROOT = { check_trade_cities = yes }
				FROM = { check_trade_cities = yes }
			}
		}
		effect = {
			### RELIGION SYSTEM 20. ###
			ROOT = { FROM.FROM = { get_religion_state_compliance_modifier = yes } }
		}
		effect = {
			### UNIFICATION - DYNAMIC MODIFIER ###
			FROM.FROM = {
				set_variable = { state_unification_compliance = ROOT.country_unification_bonus }
				set_variable = { state_unification_resistance = ROOT.country_unification_bonus2 }
			}
		}
		effect = {
			### DISLOYAL CLANS - DYNAMIC MODIFIER ###
			if = {
				limit = {
					FROM.FROM = { has_dynamic_modifier = { modifier = KYU_clan_resistance_modifier } }
				}
				FROM.FROM = { get_KYU_clan_resistance_modifier = yes }
			}
		}
	}
}
